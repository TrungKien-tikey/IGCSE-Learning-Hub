<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Chat 1-1 (Load History qua Socket)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        .box { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; border-radius: 5px; }
        #messages { height: 300px; overflow-y: scroll; border: 1px solid #ddd; padding: 10px; background: #f9f9f9; }
        .message { margin-bottom: 5px; padding: 5px; border-radius: 4px; clear: both; }
        .my-msg { background-color: #e3f2fd; float: right; }
        .other-msg { background-color: #fff3cd; float: left; }
        .clearfix::after { content: ""; clear: both; display: table; }
    </style>
</head>
<body>

    <h2>üì® Test Chat (Load History b·∫±ng @SubscribeMapping)</h2>

    <div class="box">
        <h3>1. K·∫øt n·ªëi</h3>
        <label>ID C·ªßa B·∫°n:</label>
        <input type="number" id="myId" value="1">
        <label style="margin-left: 20px;">Room ID:</label> 
        <input type="text" id="roomId" value="room_1_2">
        <br><br>
        <button onclick="connect()" id="btnConnect">K·∫øt N·ªëi & V√†o Ph√≤ng</button>
        <span id="status" style="color: red; margin-left: 10px;">Ch∆∞a k·∫øt n·ªëi</span>
    </div>

    <div class="box" id="chatArea" style="opacity: 0.5; pointer-events: none;">
        <h3>2. Chat</h3>
        <label>Ng∆∞·ªùi nh·∫≠n ID:</label> <input type="number" id="receiverId" value="2" style="width: 50px;">
        
        <br><br>
        <div id="messages" class="clearfix"></div>
        <br>
        <input type="text" id="msgContent" placeholder="Nh·∫≠p tin nh·∫Øn..." style="width: 70%;">
        <button onclick="sendMessage()">G·ª≠i</button>
    </div>

    <script>
        var stompClient = null;
        var myId = null;
        var BASE_URL = 'http://localhost:8083'; // C·∫•u h√¨nh ƒë·ªãa ch·ªâ Server

        function connect() {
            myId = document.getElementById('myId').value;
            var roomId = document.getElementById('roomId').value;

            if(!myId || !roomId) { alert("Nh·∫≠p ID v√† Room ID ƒëi b·∫°n ∆°i!"); return; }

            var socket = new SockJS(BASE_URL + '/ws');
            stompClient = Stomp.over(socket);

            stompClient.connect({}, function (frame) {
                console.log('Connected: ' + frame);
                document.getElementById('status').innerText = "ƒê√£ k·∫øt n·ªëi! (ID: " + myId + ")";
                document.getElementById('status').style.color = "green";
                document.getElementById('btnConnect').disabled = true;
                
                // M·ªü kh√≥a chat
                document.getElementById('chatArea').style.opacity = "1";
                document.getElementById('chatArea').style.pointerEvents = "auto";

                // --- PH·∫¶N QUAN TR·ªåNG NH·∫§T: LOAD L·ªäCH S·ª¨ ---
                // Subscribe v√†o "/app/history/..." thay v√¨ "/topic/..."
                // Backend @SubscribeMapping s·∫Ω b·∫Øt link n√†y v√† tr·∫£ d·ªØ li·ªáu v·ªÅ NGAY L·∫¨P T·ª®C
                console.log("ƒêang request l·ªãch s·ª≠ t·ª´: /app/history/" + roomId);
                
                stompClient.subscribe('/app/history/' + roomId, function (historyPayload) {
                    console.log("ƒê√£ nh·∫≠n l·ªãch s·ª≠ chat!");
                    var historyList = JSON.parse(historyPayload.body);
                    
                    // X√≥a tr·∫Øng m√†n h√¨nh tr∆∞·ªõc khi render
                    document.getElementById('messages').innerHTML = '';
                    
                    // Hi·ªÉn th·ªã t·ª´ng tin nh·∫Øn c≈©
                    historyList.forEach(msg => {
                        showMessage(msg);
                    });
                });

                // --- L·∫Øng nghe tin nh·∫Øn m·ªõi (Real-time) ---
                stompClient.subscribe('/queue/messages/' + myId, function (messageOutput) {
                    showMessage(JSON.parse(messageOutput.body));
                });

            }, function(error) {
                alert("L·ªói k·∫øt n·ªëi Server: " + error);
                console.error(error);
            });
        }

        function sendMessage() {
            var receiverId = document.getElementById('receiverId').value;
            var content = document.getElementById('msgContent').value;
            var roomId = document.getElementById('roomId').value;

            if(!content) return;

            var chatMessage = {
                senderId: myId,
                receiverId: receiverId,
                roomId: roomId,
                content: content
            };

            // G·ª≠i tin nh·∫Øn l√™n server
            stompClient.send("/app/private-message", {}, JSON.stringify(chatMessage));
            document.getElementById('msgContent').value = '';
        }

        function showMessage(message) {
            var response = document.getElementById('messages');
            var div = document.createElement('div');
            
            var isMyMessage = (message.senderId == myId);
            div.className = 'message ' + (isMyMessage ? 'my-msg' : 'other-msg');
            
            var timeString = "";
            if(message.timestamp) {
                var date = new Date(message.timestamp);
                if(!isNaN(date.getTime())) {
                    timeString = date.toLocaleTimeString();
                }
            }

            var senderLabel = isMyMessage ? "T√¥i" : "User " + message.senderId;
            div.innerHTML = "<strong>" + senderLabel + ":</strong> " + message.content + 
                            " <br><small style='font-size:0.7em; color:gray'>" + timeString + "</small>";
            
            response.appendChild(div);
            response.scrollTop = response.scrollHeight; 
        }
    </script>
</body>
</html>